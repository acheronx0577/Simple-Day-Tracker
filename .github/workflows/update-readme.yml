name: ğŸ“š Update README with Daily Fact

on:
  schedule:
    - cron: "0 16 * * *"
  workflow_dispatch:

jobs:
  update-readme:
    name: ğŸ—“ï¸ Update Daily Fact
    runs-on: ubuntu-latest
    
    steps:
      # Step 1: Checkout repository with CRITICAL FIX
      - name: ğŸ”„ Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_PAT }}
          persist-credentials: false  # â† THIS IS THE KEY FIX!
          fetch-depth: 0

      # Step 2: Setup Git configuration
      - name: âš™ï¸ Setup Git Identity
        run: |
          git config --global user.name "acheronx0577"
          git config --global user.email "nightcorekillbot@gmail.com"

      # Step 3: Sync with remote
      - name: ğŸ”„ Sync with Remote
        run: |
          echo "ğŸ”„ Pulling latest changes from remote..."
          git pull origin main
          echo "âœ… Successfully synced with remote"

      # Step 4: Get current date information
      - name: ğŸ“… Get Current Date
        id: date
        run: |
          echo "date_slash=$(date +'%m/%d')" >> $GITHUB_OUTPUT
          echo "date_display=$(date +'%B %d')" >> $GITHUB_OUTPUT
          echo "iso_date=$(date -u +'%Y-%m-%d')" >> $GITHUB_OUTPUT
          echo "weekday=$(date +'%A')" >> $GITHUB_OUTPUT
          echo "day_num=$(date +'%d' | sed 's/^0//')" >> $GITHUB_OUTPUT
          echo "month_num=$(date +'%m' | sed 's/^0//')" >> $GITHUB_OUTPUT

      # Step 5: Fetch daily fact
      - name: ğŸŒ Fetch Daily Fact
        id: fact
        run: |
          set +e
          echo "ğŸ¯ Fetching fact for: ${{ steps.date.outputs.date_display }}"
          
          # Your fact fetching code here...
          FACT=$(curl -s --max-time 10 "http://numbersapi.com/${{ steps.date.outputs.date_slash }}/date" | head -c 200)
          
          if [ -n "$FACT" ] && [[ ! "$FACT" =~ "does not exist" ]] && [[ ! "$FACT" =~ "Not Found" ]] && [[ ! "$FACT" =~ "null" ]]; then
            echo "âœ… Success with Numbers API"
          else
            FACT="On ${{ steps.date.outputs.date_display }}, history continues to unfold with remarkable events and discoveries."
          fi
          
          FACT=$(echo "$FACT" | tr -d '\r' | sed 's/^"//' | sed 's/"$//' | sed 's/\\//g')
          echo "ğŸ“– Final Fact: $FACT"
          
          ESCAPED_FACT=$(printf '%s' "$FACT" | sed 's/[\/&]/\\&/g')
          echo "fact=$FACT" >> $GITHUB_OUTPUT
          echo "escaped_fact=$ESCAPED_FACT" >> $GITHUB_OUTPUT

      # Step 6: Update README file
      - name: ğŸ“ Update README
        run: |
          echo "ğŸ”„ Updating README.md..."
          cp README.md README.md.backup
          
          if sed -i "s|<!-- DAILY_FACT -->.*|<!-- DAILY_FACT -->\n\`\`\`plaintext\nğŸ“Œ Daily Fact: ${{ steps.fact.outputs.fact }}\n\`\`\`|" README.md; then
            echo "âœ… README updated successfully"
            git diff README.md | head -20 || true
          else
            echo "âŒ Failed to update README, restoring backup"
            mv README.md.backup README.md
            exit 1
          fi
          rm README.md.backup

      # Step 7: Manual Git Authentication (IMPORTANT)
      - name: ğŸ”‘ Manual Git Authentication
        run: |
          echo "ğŸ”‘ Setting up manual Git authentication..."
          git remote set-url origin https://${{ secrets.GH_PAT }}@github.com/${{ github.repository }}.git

      # Step 8: Commit and push changes
      - name: ğŸš€ Commit and Push Changes
        run: |
          echo "ğŸ” Checking for changes..."
          git status --porcelain
          
          if ! git diff --quiet README.md; then
            echo "ğŸ“¦ Staging README.md..."
            git add README.md
            
            echo "ğŸ’¾ Creating commit..."
            git commit -m "ğŸ“š Daily fact update: ${{ steps.date.outputs.iso_date }}" \
                      -m "Automated update for ${{ steps.date.outputs.date_display }}" \
                      -m "Fact: ${{ steps.fact.outputs.fact }}"
            
            echo "ğŸ” Verifying commit..."
            echo "Commit author: $(git log -1 --pretty=format:'%an <%ae>')"
            
            echo "ğŸ“¤ Pushing to origin/main..."
            git push origin main
            
            echo "ğŸ‰ Successfully committed and pushed daily fact update!"
          else
            echo "âœ… No changes to commit"
          fi

      # Step 9: Summary
      - name: ğŸ“‹ Summary
        if: always()
        run: |
          echo " "
          echo "ğŸ WORKFLOW SUMMARY"
          echo "===================="
          echo "ğŸ“… Date: ${{ steps.date.outputs.date_display }}"
          echo "ğŸ“– Fact: ${{ steps.fact.outputs.fact }}"
          echo "ğŸ“§ Commit Author: acheronx0577 <nightcorekillbot@gmail.com>"
          echo "ğŸ”‘ Auth Method: PAT with persist-credentials: false"
          echo "ğŸ•’ Time: $(date -u +'%H:%M:%S UTC')"
          echo "âœ… Status: ${{ job.status }}"
          echo " "
